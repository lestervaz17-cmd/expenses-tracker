<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            padding: 2rem;
        }
        .card {
            background-color: #fff;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .form-input, .form-select {
            width: 100%;
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid #d1d5db;
            transition: all 0.2s;
        }
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2);
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .btn-primary {
            background-color: #4f46e5;
            color: #fff;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        .btn-danger {
            background-color: #ef4444;
            color: #fff;
        }
        .btn-danger:hover {
            background-color: #dc2626;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        /* Custom message box */
        #message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 2rem;
            background-color: #4f46e5;
            color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        #message-box.show {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- Auth Modal -->
    <div id="auth-modal" class="modal">
        <div class="card p-8 text-center">
            <h2 id="auth-title" class="text-2xl font-bold mb-4">Log in to your account</h2>
            <p id="auth-message" class="text-gray-500 mb-6 hidden"></p>
            <input type="email" id="email-input" class="form-input text-center text-lg mb-4" placeholder="Email">
            <input type="password" id="password-input" class="form-input text-center text-lg" placeholder="Password">
            <button id="auth-submit-btn" class="btn btn-primary w-full mt-4">Log in</button>
            <p id="auth-error-message" class="text-red-500 mt-2 hidden"></p>
            <p class="mt-4">
                <button id="toggle-auth-mode" class="text-indigo-600 hover:underline">New user? Create an account</button>
            </p>
        </div>
    </div>

    <!-- Main Application Container -->
    <div id="app-container" class="container hidden">
        <header class="flex flex-col md:flex-row justify-between items-center my-8 p-6 bg-white rounded-xl shadow-lg">
            <h1 class="text-3xl font-bold text-gray-800 mb-4 md:mb-0">Expense Tracker</h1>
            <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4 w-full md:w-auto">
                <button id="download-csv-btn" class="btn btn-primary w-full md:w-auto">Download CSV</button>
                <div class="relative w-full md:w-auto">
                    <input type="text" id="filter-input" placeholder="Filter by description..." class="form-input w-full md:w-auto pr-10">
                    <svg xmlns="http://www.w3.org/2000/svg" class="absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
                <button id="logout-btn" class="btn bg-gray-600 text-white w-full md:w-auto hover:bg-gray-700">Logout</button>
            </div>
        </header>

        <!-- Welcome Message -->
        <div id="welcome-message" class="hidden text-center text-lg font-medium text-gray-700 my-4">
            Welcome! Select an account or create a new one to get started.
        </div>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Left Column: Account Management & Transaction Form -->
            <section class="lg:col-span-1 space-y-6">
                <!-- Account Management (moved to the top of the left column) -->
                <div class="card space-y-4">
                    <h2 class="text-2xl font-bold">Account Management</h2>
                    <div id="accounts-container" class="flex flex-wrap gap-2">
                        <!-- Account buttons will be injected here -->
                    </div>
                    <input type="text" id="new-account-input" class="form-input" placeholder="New Account Name">
                    <button id="add-account-btn" class="btn btn-primary w-full">Add Account</button>
                </div>

                <!-- Transaction Form (hidden until account is added) -->
                <div id="transaction-form-card" class="card hidden">
                    <h2 class="text-2xl font-bold mb-4">Add Transaction</h2>
                    <form id="transaction-form" class="space-y-4">
                        <div>
                            <label for="date" class="block text-gray-700">Date</label>
                            <input type="date" id="date" class="form-input mt-1" required>
                        </div>
                        <div>
                            <label for="payment-method" class="block text-gray-700">Payment Method</label>
                            <select id="payment-method" class="form-select mt-1" required>
                                <option value="CASH">CASH</option>
                                <option value="GPAY">GPAY</option>
                                <option value="PHONEPE">PHONEPE</option>
                                <option value="CHEQUE">CHEQUE</option>
                            </select>
                        </div>
                        <div>
                            <label for="paid-to" class="block text-gray-700">Paid To</label>
                            <input type="text" id="paid-to" class="form-input mt-1" placeholder="Store Name" required>
                        </div>
                        <div>
                            <label for="description" class="block text-gray-700">Description</label>
                            <input type="text" id="description" class="form-input mt-1" placeholder="Groceries, Salary, etc.">
                        </div>
                        <div>
                            <label for="amount-received" class="block text-gray-700">Amount Received</label>
                            <input type="number" id="amount-received" class="form-input mt-1" step="0.01" value="0">
                        </div>
                        <div>
                            <label for="amount-paid" class="block text-gray-700">Amount Paid</label>
                            <input type="number" id="amount-paid" class="form-input mt-1" step="0.01" value="0">
                        </div>
                        <button type="submit" id="add-update-btn" class="btn btn-primary w-full">Add Transaction</button>
                    </form>
                </div>
            </section>

            <!-- Right Column: Financial Summary & Transaction History -->
            <section class="lg:col-span-2 space-y-6 hidden" id="main-content">
                <!-- Financial Summary (moved to the top of the right column) -->
                <div class="card space-y-4 bg-gradient-to-r from-indigo-500 to-indigo-600 text-white shadow-xl">
                    <h2 class="text-2xl font-bold">Financial Summary</h2>
                    <p class="text-xl font-medium">Total Balance: <span id="total-balance" class="font-bold">₹0.00</span></p>
                    <p class="text-xl font-medium">Running Total: <span id="running-total" class="font-bold">₹0.00</span></p>
                </div>

                <!-- Transaction History (part of the main content) -->
                <div class="card">
                    <h2 class="text-2xl font-bold mb-4">Transaction History</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Method</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Paid To</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Received</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Paid</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Balance</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="transaction-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Transactions will be added here dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Message Box for transaction alerts -->
    <div id="message-box" class="hidden"></div>

    <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDocs, collection, onSnapshot, query, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Global variables provided by the Canvas environment
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let app, auth, db;
    let userId = null;
    let currentAccount = 'Main';
    let isUpdatingTransaction = false;
    let transactionToUpdateIndex = -1;
    let data = {};
    let authMode = 'login'; // 'login' or 'register'

    // DOM Elements
    const authModal = document.getElementById('auth-modal');
    const authTitle = document.getElementById('auth-title');
    const authMessage = document.getElementById('auth-message');
    const emailInput = document.getElementById('email-input');
    const passwordInput = document.getElementById('password-input');
    const authSubmitBtn = document.getElementById('auth-submit-btn');
    const authErrorMessage = document.getElementById('auth-error-message');
    const toggleAuthModeBtn = document.getElementById('toggle-auth-mode');
    const appContainer = document.getElementById('app-container');
    const mainContent = document.getElementById('main-content');
    const transactionFormCard = document.getElementById('transaction-form-card');
    const logoutBtn = document.getElementById('logout-btn');
    const welcomeMessage = document.getElementById('welcome-message');
    const addUpdateBtn = document.getElementById('add-update-btn');
    const transactionForm = document.getElementById('transaction-form');
    const dateInput = document.getElementById('date');
    const paymentMethodInput = document.getElementById('payment-method');
    const paidToInput = document.getElementById('paid-to');
    const descriptionInput = document.getElementById('description');
    const amountReceivedInput = document.getElementById('amount-received');
    const amountPaidInput = document.getElementById('amount-paid');
    const totalBalanceEl = document.getElementById('total-balance');
    const runningTotalEl = document.getElementById('running-total');
    const transactionTableBody = document.getElementById('transaction-table-body');
    const downloadCsvBtn = document.getElementById('download-csv-btn');
    const filterInput = document.getElementById('filter-input');
    const accountsContainer = document.getElementById('accounts-container');
    const newAccountInput = document.getElementById('new-account-input');
    const addAccountBtn = document.getElementById('add-account-btn');

    // --- Firebase Initialization and Auth ---
    async function initializeFirebase() {
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log('Firebase initialized.');
        } catch (e) {
            console.error('Error initializing Firebase:', e);
            authMessage.textContent = 'Failed to connect to the backend. Please try again later.';
            authMessage.classList.remove('hidden');
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                authModal.classList.add('hidden');
                appContainer.classList.remove('hidden');
                welcomeMessage.classList.remove('hidden');
                console.log('User signed in:', userId);
                await loadData();
            } else {
                userId = null;
                authModal.classList.remove('hidden');
                appContainer.classList.add('hidden');
                console.log('User signed out.');
            }
        });

        // Use the provided auth token if available, otherwise sign in anonymously
        if (initialAuthToken) {
            try {
                await signInWithCustomToken(auth, initialAuthToken);
            } catch (error) {
                console.error("Error signing in with custom token:", error);
                await signInAnonymously(auth);
            }
        } else {
            await signInAnonymously(auth);
        }
    }

    // --- Authentication Logic ---
    authSubmitBtn.addEventListener('click', async () => {
        const email = emailInput.value.trim();
        const password = passwordInput.value.trim();
        if (!email || !password) {
            authErrorMessage.textContent = 'Please enter both email and password.';
            authErrorMessage.classList.remove('hidden');
            return;
        }

        authErrorMessage.classList.add('hidden');

        try {
            if (authMode === 'login') {
                await signInWithEmailAndPassword(auth, email, password);
            } else {
                await createUserWithEmailAndPassword(auth, email, password);
            }
        } catch (error) {
            console.error('Authentication error:', error);
            authErrorMessage.textContent = error.message.replace('Firebase: ', '');
            authErrorMessage.classList.remove('hidden');
        }
    });

    toggleAuthModeBtn.addEventListener('click', () => {
        if (authMode === 'login') {
            authMode = 'register';
            authTitle.textContent = 'Create a new account';
            authSubmitBtn.textContent = 'Register';
            toggleAuthModeBtn.textContent = 'Already have an account? Log in';
        } else {
            authMode = 'login';
            authTitle.textContent = 'Log in to your account';
            authSubmitBtn.textContent = 'Log in';
            toggleAuthModeBtn.textContent = 'New user? Create an account';
        }
        authErrorMessage.classList.add('hidden');
    });

    logoutBtn.addEventListener('click', async () => {
        try {
            await signOut(auth);
            // The onAuthStateChanged listener will handle UI changes
        } catch (error) {
            console.error('Logout failed:', error);
        }
    });

    // --- Firestore Data Management ---
    async function loadData() {
        if (!userId || !db) return;

        const accountsRef = collection(db, `artifacts/${appId}/users/${userId}/accounts`);

        // Use onSnapshot for real-time updates
        onSnapshot(accountsRef, (snapshot) => {
            snapshot.docChanges().forEach(change => {
                const accountData = change.doc.data();
                data[accountData.id] = accountData.transactions || [];
            });
            // Update the current account if it's no longer in the list
            if (!data[currentAccount] && Object.keys(data).length > 0) {
                 currentAccount = Object.keys(data)[0];
            } else if (Object.keys(data).length === 0) {
                currentAccount = null;
            }
            renderAccounts();
            updateUI();
        }, (error) => {
            console.error("Error listening to accounts:", error);
        });
    }

    async function saveAccountData(accountId, transactions) {
        if (!userId) return;
        const accountDocRef = doc(db, `artifacts/${appId}/users/${userId}/accounts`, accountId);
        await setDoc(accountDocRef, {
            id: accountId,
            transactions: transactions
        });
    }

    async function deleteTransactionFromDb(accountId, transactionIndex) {
        if (!userId || !accountId) return;

        let transactions = data[accountId] || [];
        transactions.splice(transactionIndex, 1);
        await saveAccountData(accountId, transactions);
    }

    // --- Account Management ---
    function renderAccounts() {
        accountsContainer.innerHTML = '';
        const accountNames = Object.keys(data);
        if (accountNames.length > 0) {
            mainContent.classList.remove('hidden');
            transactionFormCard.classList.remove('hidden');
        } else {
            mainContent.classList.add('hidden');
            transactionFormCard.classList.add('hidden');
        }
        accountNames.forEach(accountName => {
            const button = document.createElement('button');
            button.textContent = accountName;
            button.classList.add('btn', 'p-2', 'text-sm');
            if (accountName === currentAccount) {
                button.classList.add('bg-indigo-600', 'text-white');
            } else {
                button.classList.add('bg-gray-200', 'text-gray-800');
            }
            button.addEventListener('click', () => {
                currentAccount = accountName;
                renderAccounts();
                updateUI();
            });
            accountsContainer.appendChild(button);
        });
    }

    addAccountBtn.addEventListener('click', async () => {
        const accountName = newAccountInput.value.trim();
        if (accountName && !data[accountName]) {
            data[accountName] = [];
            currentAccount = accountName;
            newAccountInput.value = '';
            await saveAccountData(accountName, []);
            showMessage('Account added successfully!');
        }
    });

    // --- Transaction Management & UI Update ---
    transactionForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const amountReceived = parseFloat(amountReceivedInput.value) || 0;
        const amountPaid = parseFloat(amountPaidInput.value) || 0;

        const newTransaction = {
            date: dateInput.value,
            paymentMethod: paymentMethodInput.value,
            paidTo: paidToInput.value,
            description: descriptionInput.value,
            amountReceived: amountReceived,
            amountPaid: amountPaid,
        };

        if (isUpdatingTransaction) {
            data[currentAccount][transactionToUpdateIndex] = newTransaction;
            isUpdatingTransaction = false;
            transactionToUpdateIndex = -1;
            addUpdateBtn.textContent = 'Add Transaction';
            showMessage('Transaction updated successfully!');
        } else {
             if (!data[currentAccount]) {
                data[currentAccount] = [];
            }
            data[currentAccount].push(newTransaction);
            showMessage('Transaction added successfully!');
        }

        await saveAccountData(currentAccount, data[currentAccount]);
        resetForm();
    });

    function resetForm() {
        transactionForm.reset();
        dateInput.valueAsDate = new Date();
        amountReceivedInput.value = 0;
        amountPaidInput.value = 0;
    }

    function updateUI() {
        const transactions = data[currentAccount] || [];
        let runningTotal = 0;
        let totalReceived = 0;
        let totalPaid = 0;

        transactionTableBody.innerHTML = '';

        const filteredTransactions = transactions.filter(t =>
            t.description.toLowerCase().includes(filterInput.value.toLowerCase()) ||
            t.paidTo.toLowerCase().includes(filterInput.value.toLowerCase())
        );

        filteredTransactions.forEach((transaction, index) => {
            const row = document.createElement('tr');
            runningTotal += transaction.amountReceived - transaction.amountPaid;
            totalReceived += transaction.amountReceived;
            totalPaid += transaction.amountPaid;

            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${transaction.date}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${transaction.paymentMethod}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${transaction.paidTo}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${transaction.description}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-green-600">₹${transaction.amountReceived.toFixed(2)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-right text-red-600">₹${transaction.amountPaid.toFixed(2)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-right">₹${runningTotal.toFixed(2)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                    <button class="text-indigo-600 hover:text-indigo-900 update-btn" data-index="${index}">Update</button>
                    <button class="text-red-600 hover:text-red-900 delete-btn" data-index="${index}">Delete</button>
                </td>
            `;
            transactionTableBody.appendChild(row);
        });

        totalBalanceEl.textContent = '₹' + (totalReceived - totalPaid).toFixed(2);
        runningTotalEl.textContent = '₹' + runningTotal.toFixed(2);

        // Add event listeners for update and delete buttons
        document.querySelectorAll('.update-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const index = parseInt(e.target.getAttribute('data-index'));
                editTransaction(index);
            });
        });
        document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', async (e) => {
                const index = parseInt(e.target.getAttribute('data-index'));
                await deleteTransactionFromDb(currentAccount, index);
                showMessage('Transaction deleted successfully!');
            });
        });
    }

    function editTransaction(index) {
        const transaction = data[currentAccount][index];
        dateInput.value = transaction.date;
        paymentMethodInput.value = transaction.paymentMethod;
        paidToInput.value = transaction.paidTo;
        descriptionInput.value = transaction.description;
        amountReceivedInput.value = transaction.amountReceived;
        amountPaidInput.value = transaction.amountPaid;

        isUpdatingTransaction = true;
        transactionToUpdateIndex = index;
        addUpdateBtn.textContent = 'Update Transaction';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    filterInput.addEventListener('input', updateUI);

    // --- CSV Download Functionality ---
    downloadCsvBtn.addEventListener('click', () => {
        const transactions = data[currentAccount] || [];
        if (transactions.length === 0) {
            return;
        }

        const header = ["Date", "Payment Method", "Paid To", "Description", "Amount Received", "Amount Paid", "Running Total"];
        let csvContent = header.join(",") + "\n";
        let runningTotal = 0;

        transactions.forEach(t => {
            runningTotal += t.amountReceived - t.amountPaid;
            const row = [
                t.date,
                t.paymentMethod,
                t.paidTo,
                t.description,
                t.amountReceived.toFixed(2),
                t.amountPaid.toFixed(2),
                runningTotal.toFixed(2)
            ];
            csvContent += row.join(",") + "\n";
        });

        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", `${currentAccount}_transactions.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });

    // --- Custom Message Box Logic ---
    function showMessage(text) {
        const messageBox = document.getElementById('message-box');
        messageBox.textContent = text;
        messageBox.classList.remove('hidden');
        messageBox.classList.add('show');
        setTimeout(() => {
            messageBox.classList.remove('show');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 300);
        }, 3000);
    }

    // Set today's date on page load
    document.addEventListener('DOMContentLoaded', () => {
        dateInput.valueAsDate = new Date();
        initializeFirebase();
    });
    </script>
</body>
</html>
